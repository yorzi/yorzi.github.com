





<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="zh"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="zh"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh"><![endif]-->
<!--[if gt IE 8]<!-->
<html class="no-js" lang="zh">
  <!--<![endif]-->
  <head>
    <meta charset="UTF-8">

    <title>
      A Great Survey Solution Based On Ruby on Rails - @yorzi
    </title>

    <meta name="description" content="安迪的思考和分享">
    <meta name="keywords" content="Remote Working,Project Management,Team Collaboration,Startup,Entrepreneurship,Ruby/Rails,Web Development,生活">
    <meta name="author" content="Andy Wang">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="cleartype" content="on">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="57x57" href="/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png" />
    <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">

    <link rel="icon" type="image/png" sizes="16x16" href="/wangyaodi.png">
    <link rel="shortcut icon" sizes="16x16" href="/wangyaodi.png">
    <link rel="alternate" type="application/rss+xml" title="@yorzi's Homepage" href="/feed.xml" />
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="/stylesheets/application.css">
    <script src="/javascripts/all.js"></script>
  </head>
  <body class="x2010 x2010_07 x2010_07_27 x2010_07_27_a-great-survey-solution-based-on-ruby-on-rails">
    <aside class="sidebar">
      <h1 class="site-name"><a href="/" style='color:rgb(162, 9, 9);'>@yorzi</a></h1>
      <nav class="global-nav">
        <ul>
          <li><a href="/profile.html">About</a></li>
          <li><a href="/presentations.html">Presentations</a></li>
          <li><a href="/files/2013-Andy-Wang-Resume-Via-Linkedin.pdf">Resume</a></li>
        </ul>
      </nav>

      <nav class="social-connect">
        <ul>
          <li><a href="//github.com/yorzi"><i class="icon-github"></i></a></li>
          <li><a href="//weibo.com/yorzi"><i class="icon-weibo"></i></a></li>
          <li><a href="//twitter.com/yorzi"><i class="icon-twitter"></i></a></li>
          <li><a href="//cn.linkedin.com/in/yorzi"><i class="icon-linkedin"></i></a></li>
        </ul>
      </nav>

      <!-- Ad -->
      <div class="block ad">
        <p class="block-cnt">Themed By</p>
        <h4 class="block-title"><a href="//fengche.co">风车</a></h4>
      </div>

    </aside>

    <section class="main">
      <div class="container">
        
  <div class="announcement">
    <p>
        <img class="avatar" src="/images/wangyaodi.png" alt="Andy Wang" />
为了练习写作，我开了一个微信公众号<a href='/2015/10/25/why-to-practise-writing-an-article.html'>【爱成长】</a>，每篇Blog都会同步在该公众号中发布，请感兴趣的朋友关注我的微信公众号，微信ID：i-chengzhang 谢谢！


    </p>
  </div>

  <article class="post single">

    <header>
  <h2 class="title">
    <a href="/2010/07/27/a-great-survey-solution-based-on-ruby-on-rails.html">A Great Survey Solution Based On Ruby on Rails</a>
  </h2>
</header>

<aside class="aside-block">
  <ul class="meta">
    <li class="date">
      Jul 27, 2010
    </li>
    <li class="tags">
    </li>
  </ul>
</aside>

<div class="content">
  <p>I&rsquo;ve been always looking for a powerful and flexible survey solution for a while, now I find it : <a href="http://github.com/breakpointer/surveyor">Surveyor</a>.</p>

<p><strong>What&rsquo;s a Survey? </strong>
Here is a brief look at the similarities and differences between forms, surveys, questionnaires and quizzes.</p>

<p>Forms are a series of fields to be filled out by a user. Some forms are highly structured (such as a User form, or an Address form). Those highly structured forms can be created beforehand by a developer because they can map directly to models in the database. Other forms are highly unstructured, such as a questionnaire about your favorite types of food which are volatile. So form is simple structured format.</p>

<p>A Survey is a type of Form. Surveys are semi-structured data, in that we want to formulate the questions so they have “mineable” data, but they are not so structured as to be directly mappable to database tables (unless we desired to have one table per survey, do we?). Also If a survey field is not appropriately filled out (such as a misformatting), the user should be prompted to correct his/her answer. According to this needs, surveys should not prevent the user from completing them if they miss an answer, however. A Questionnaire is a type of Survey and meanwhile, a Quiz is also a type of Survey.</p>

<p><strong>How To Set Up Surveys Via Surveyor?</strong>
There is already a clear manual for helping people to use Surveyor <a href="http://github.com/breakpointer/surveyor">here</a>. You can find most of what you want directly in <a href="http://wiki.github.com/breakpointer/surveyor/">Surveyor&rsquo;s official wiki</a>. However, I still want to share my experience on using Surveyor.</p>

<p><strong>Install Surveyor.</strong>
As a plugin:
<pre>gem install haml
gem install fastercsv
script/plugin install git://github.com/breakpointer/surveyor.git -r &#39;tag v0.11.0&#39;
</pre>
Or as a gem:
<pre># in environment.rb</p>

<h2>config.gem &quot;surveyor&quot;, :version =&gt; &#39;~&gt; 0.11.0&#39;, :source =&gt; &#39;<a href="http://gemcutter.org">http://gemcutter.org</a>&#39;</h2>

<p>rake gems:install</pre>
Surveyor is relied on haml and fastercsv(this is for supporting export csv survey results)
Generate assets, run migrations:
<pre>script/generate surveyor
rake db:migrate</pre>
Try out the &ldquo;kitchen sink&rdquo; survey:
<code>rake surveyor FILE=surveys/kitchen<em>sink</em>survey.rb FIXTURES=surveys/fixtures
</code>
The rake surveyor task overwrites previous surveys by default, but can append instead:
<code>rake surveyor FILE=surveys/kitchen<em>sink</em>survey.rb FIXTURES=surveys/fixtures APPEND=true</code></p>

<p>Now start your Rails server, you will see the demo survey &ldquo;kitchen sink&rdquo; on localhost:3000/surveys. This demo is pretty useful for you when you generate your own survey pattern. Because in kitchen sink demo, most of &ldquo;Survey API&rdquo; are there.</p>

<p><strong>Survey Sample</strong>
Well, let&rsquo;s create our first survey. I paste my first as below, we can take a look at the way Surveyor support.
<code lang='ruby'></p>

<h1>/surveys/salon_survey.rb</h1>

<p>survey &quot;欢迎您访问Idapted技术沙龙活动调查问卷！&quot; do</p>

<p>section &quot;[Rails系统重构最佳实践]@beta-salon 2010/07/24&quot; do
    # A label is a question that accepts no answers
    label &quot;<b>希望您填写自己的个人信息，我们会为您提供最快速和专业的Ruby on Rails技术活动资讯！</b>&quot;</p>
<pre class="highlight plaintext"><code># When :pick isn't specified, the default is :none (no checkbox or radio button)
q_1 "请填写您的姓名(中英文名均可)"
a_1 :string

q_3 "请填写您的电话(如果我们有更多后续的技术交流活动，我们会发短信通知您:))"
a_3 :string

q_3 "请填写您的邮箱(如果我们有更多后续的技术交流活动，我们也会发邮件通知您:))"
a_3 :string

# A basic question with checkboxes
# "question" and "answer" may be abbreviated as "q" and "a"
q_2 "我们公司(Idapted)的产品涉及到以下几种技术，请选择您喜欢的主题，我们的研发团队会根据大家的反馈继续开展相关技术交流活动！", :pick =&gt; :any
a_1 "Ruby on Rails"
a_2 "Flex/Flash"
a_3 "VoIP/FreeSwitch"
a_4 "Erlang"
a_5 "Titanium/iPhone/iTouch/iPad Development"

# A dependent question, with conditions and rule to logically join them  
# the question's reference identifier is "2a", and the answer's reference_identifier is "1"
# question reference identifiers used in conditions need to be unique on a survey for the lookups to work
q_2a "请简单说明为什么您对所选择的技术感兴趣:)"
a_1 "说明：", :text
dependency :rule =&gt; "A or B or C or D"
condition_A :q_2, "==", :a_1
condition_B :q_2, "==", :a_2
condition_C :q_2, "==", :a_3
condition_D :q_2, "==", :a_4
condition_E :q_2, "==", :a_5

q_4 "您使用Ruby on Rails开发有多长时间了？", :pick =&gt; :one, :display_type =&gt; :slider
["刚开始", "半年", "一年", "两年", "两年以上"].each{|level| a level}

# Surveys, sections, questions, groups, and answers also take a custom css class for covenience in custom styling
q_6 "请介绍一下您自己的工作和感兴趣的技术", :custom_class =&gt; 'address'
a :text, :custom_class =&gt; 'mapper'
# validations can use regexp values
validation :rule =&gt; "A"
condition_A "=~", :regexp =&gt; /[0-9a-zA-z\. #]/
</code></pre>

<p>end
end
</code>
In above sample, I create a &ldquo;survey&rdquo;, then I also create a &ldquo;section&rdquo; inside a survey. Yeah, you can define many section for a survey to make the whole survey being like a wizard, that&rsquo;s pretty interesting. In on survey, there are more than 15 types of question, you can define a survey as using plain English, what you should obey is to refer to Kitchen Sink sample, it means you can only define a question type according to the certain rule, don&rsquo;t worry, the rule is simple.</p>

<p>Once you finished defining the survey, it means you now have a ruby file, say salon<em>survey.rb, you should run the following commend in your terminal to migrate all your survey items into your application, remember the append command, it will let you not to delete previous survey which stored in the same application.
<pre>rake surveyor FILE=surveys/salon</em>survey.rb FIXTURES=surveys/fixtures APPEND=true</pre>
Wow, you now have your new survey list in the Survey root path after you restart your server. I guess you will like it.</p>

<p><strong>Customize Survey</strong>
All go well so far, But, there is a big weakness of this survey solution if you only use it as above. Because the Surveyor doesn&rsquo;t support any easy way to manage the survey results. You should add the administration side in your application by yourself. I will also give you some hints on doing this.</p>

<p>Before your create management part for survey results, I remind you take a look at the survey configure file where you can do some really simple config for specific survey, such as define welcome page and finish page, or the survey title you want to customize. It&rsquo;s something as below:
<code lang='ruby'></p>

<h1>Initializers/surveyor.rb</h1>

<h1>Loaded once. Restart your app (even in development) to apply changes made here</h1>

<p>Surveyor::Config.run do |config|
  config[&#39;default.relative<em>url</em>root&#39;] = &quot;surveys&quot; #nil # &quot;surveys&quot;
  config[&#39;default.title&#39;] = &quot;EQ英语(Idapted) 技术沙龙调查问卷&quot; #nil # &quot;You can take these surveys:&quot;
  config[&#39;default.layout&#39;] = &quot;surveyor<em>custom&quot; # &quot;surveyor</em>default&quot;
  config[&#39;default.index&#39;] = nil#:welcome<em>pages</em>path #:welcome<em>pages</em>path # &quot;/surveys&quot; # or :index<em>path</em>method
  config[&#39;default.finish&#39;] =  :thankyou<em>pages</em>path # &quot;/surveys&quot; # or :finish<em>path</em>method
  config[&#39;use<em>restful</em>authentication&#39;] = false # set to true to use restful authentication
  config[&#39;extend&#39;] = %w(survey surveyor<em>helper surveyor</em>controller) #%w()
end
</code></p>

<p><strong>Survey Results Statistics</strong>
OK, last hints about adding management part of survey, here we should know clearly what&rsquo;s the survey&rsquo;s structure. So what&rsquo;s Survey&rsquo;s data structure? It&rsquo;s like this:
<pre></p>

<h1>Survey structure</h1>

<p>Survey-------Section1---------Question1---------Many Answers(From different user)
                                      ---------Q2
                                      ---------Q3
                                      ---------More Question
          -------Section2
          -------More Sections</p>

<h1>Response Structure. Each User Has one unique <strong>ResponseSet</strong></h1>

<p>ResponseSet---------Response1
                    ---------Response2
                    ---------More Responses
</pre>
So you can display all results as you need. I do it as below:
<code lang='ruby'></p>

<h1>results_controller.rb</h1>

<p>class Admin::ResultsController &lt; Admin::BaseController
  layout &quot;results&quot;</p>

<p>def index
    @surveys = Survey.all
  end</p>

<p>def show
    @survey = Survey.find(params[:id])
    @response<em>sets = @survey.response</em>sets
    @questions = SurveySection.find<em>by</em>survey_id(params[:id]).questions
  end
end</p>

<h1>View show.html.erb</h1>

<table class="list_table">
  <tr>
    <th>ID</th>
    <th>Code</th>
    <% @questions.each do |question| %>
        <% next if question.display_order == 1 %>
        <th><%= "[" +question.display_order.to_s + "]" + question.text  %></th>
    <% end %>
  </tr>

<% @response_sets.each do |r_set| %>
  <tr>
    <td><%=h r_set.id %></td>
    <td><%=h r_set.access_code %></td>
    <% @questions.each do |question| %>
        <% next if question.display_order == 1 %>
        <td><%= display_response(r_set,question) %></td>
    <% end %>
  </tr>
<% end %>
</table>

<h1>results_helper.rb</h1>

<p>module Admin::ResultsHelper
  def display<em>response(r</em>set,question)
    sets = r<em>set.responses.select{|r| r.question.display</em>order == question.display<em>order}
        if sets.size == 0
            return &quot;-&quot;
        elsif sets.size == 1
            return (sets.first.string</em>value || sets.first.text<em>value || show</em>answer(sets.first))
        else
          txt = &quot;&quot;
        sets.each do |set|
          txt &lt;&lt; show_answer(set) + &quot;<br/>&quot;
        end
        return txt
     end
  end</p>

<p>def show_answer(set)
     set.answer.text
  end
end
</code></p>

<p>God, I really make a long post, hope you can find something useful, feel free to contact me if you have any confusion.</p>

</div>

  </article>

  <div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'andyspersonalblog';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>

      </div>
    </section>

    <footer>
      <div class="copyright">
        <p>&copy;2015 Andy Wang</a></p>
      </div>
    </footer>

    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-11967621-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>