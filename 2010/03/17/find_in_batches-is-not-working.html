



<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="zh"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="zh"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh"><![endif]-->
<!--[if gt IE 8]<!-->
<html class="no-js" lang="zh">
  <!--<![endif]-->
  <head>
    <meta charset="UTF-8">

    <title>
      find_in_batches is not working - @yorzi
    </title>

    <meta name="description" content="安迪的思考和分享">
    <meta name="keywords" content="<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="zh"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="zh"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh"><![endif]-->
<!--[if gt IE 8]<!-->
<html class="no-js" lang="zh">
  <!--<![endif]-->
  <head>
    <meta charset="UTF-8">

    <title>
      find_in_batches is not working - @yorzi
    </title>

    <meta name="description" content="安迪的思考和分享">
    <meta name="keywords" content="">
    <meta name="author" content="Andy Wang">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="cleartype" content="on">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="57x57" href="/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png" />
    <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">

    <link rel="icon" type="image/png" sizes="16x16" href="/wangyaodi.png">
    <link rel="shortcut icon" sizes="16x16" href="/wangyaodi.png">
    <link rel="alternate" type="application/rss+xml" title="@yorzi's Homepage" href="/feed.xml" />
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="/stylesheets/application.css">
    <script src="/javascripts/all.js"></script>
  </head>
  <body class="2010 2010_03 2010_03_17 2010_03_17_find_in_batches-is-not-working">
    <aside class="sidebar">
      <h1 class="site-name"><a href="/" style='color:red;'>@yorzi</a></h1>
      <nav class="global-nav">
        <ul>
          <li><a href="/profile.html">About</a></li>
          <li><a href="//resume.wangyaodi.com">Resume</a></li>
        </ul>
      </nav>

      <nav class="social-connect">
        <ul>
          <li><a href="//github.com/yorzi"><i class="icon-github"></i></a></li>
          <li><a href="//weibo.com/yorzi"><i class="icon-weibo"></i></a></li>
          <li><a href="//twitter.com/yorzi"><i class="icon-twitter"></i></a></li>
          <li><a href="//cn.linkedin.com/in/yorzi"><i class="icon-linkedin"></i></a></li>
        </ul>
      </nav>

      <!-- Ad -->
      <div class="block ad">
        <p class="block-cnt">A Theme By</p>
        <h4 class="block-title"><a href="//pragmatic.ly/">Pragmatic.ly</a></h4>
      </div>

    </aside>

    <section class="main">
      <div class="container">
        
  <div class="announcement">
    <p>
      
        <img class="avatar" src="/images/wangyaodi.png" alt="Andy Wang" />


      
    </p>
  </div>

  <article class="post single">

    <header>
  <h2 class="title">
    <a href="/2010/03/17/find_in_batches-is-not-working.html">find_in_batches is not working</a>
  </h2>
</header>

<aside class="aside-block">
  <ul class="meta">
    <li class="date">
      Mar 17, 2010
    </li>
    <li class="tags">
      
    </li>
  </ul>
</aside>

<div class="content">
  <p>Days ago, I came across a situation in which <a href="http://api.rubyonrails.org/classes/ActiveRecord/Batches/ClassMethods.html">find<em>in</em>batches</a> does not work correctly, the sample code is as below:
<code lang="ruby"></p>

<h1>NOT WORKING AS EXPECTED.</h1>

<p>namespace :studycenter do
  desc &#39;generate item extra items&#39;
  task :update<em>extra</em>items =&gt; :environment do
    puts &quot;starting at #{@time = Time.now}......&quot;
    Item.find<em>in</em>batches(:conditions =&gt; {:content<em>type =&gt; &quot;Scenario&quot;}) do |items|
      items.each do |item|
        begin
          if item.extra</em>items.blank?
            item.related<em>lessons.each do |extra|
              @item = ItemExtraItem.create({:item</em>id =&gt; item.id, :extra<em>item</em>id =&gt; extra.id})
              puts &quot;=============================================#{@item.id}&quot;
            end
          end
          puts &quot;finished item with ID:#{item.id}&quot;
        rescue Exception =&gt; e
          puts &quot;something wrong happened!! item with ID:#{item.id}&quot;
          next
        end
      end
      puts &quot;------------------spent #{(Time.now - @time)/60} minutes!&quot;
    end
    puts &quot;finished at #{Time.now}, totally, spent #{(Time.now - @time)/60} minutes!&quot;
  end
end
</code>
Then I refactor this task, so I can migrate data which generated day by day.
<code lang="ruby"></p>

<h1>WORKING WELL</h1>

<p>namespace :studycenter do
  desc &#39;generate item extra items&#39;
  task :update<em>extra</em>items =&gt; :environment do
    puts &quot;starting at #{@time = Time.now}......&quot;
    (1..300).each do |n|
      items = Item.all(:conditions =&gt; [&quot;content<em>type = &#39;Scenario&#39; and items.created</em>at &gt;= ? and items.created<em>at &lt; ?&quot;,(&quot;2010-03-13&quot;.to</em>date - n.days), (&quot;2010-03-13&quot;.to<em>date - (n-1).days) ])
      items.each do |item|
        begin
          if item.extra</em>items.blank?
            item.related<em>lessons.each do |extra|
              @item = ItemExtraItem.create({:item</em>id =&gt; item.id, :extra<em>item</em>id =&gt; extra.id})
              puts &quot;=============================================#{@item.id}&quot;
            end
          end
          puts &quot;finished item with ID:#{item.id}&quot;
        rescue Exception =&gt; e
          puts &quot;something wrong happened!! item with ID:#{item.id}&quot;
          next
        end
      end
      puts &quot;------------------spent #{(Time.now - @time)/60} minutes!&quot;
    end
    puts &quot;finished at #{Time.now}, totally, spent #{(Time.now - @time)/60} minutes!&quot;
  end
end
</code>
Do you know why find<em>in</em>batches is not working here?
PS:  item.related_lessons is an item array, so the item and its related lesson are all the same class.</p>

<p><strong>Answer</strong>: In find<em>in</em>batches loop, the specific Class only has a range of its instances(e.g. 1~1000), so item.related_lessons can not find the item(e.g. 1001) out of the range..</p>

</div>

  </article>

  <div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'andyspersonalblog'; // required: replace example with your forum shortname
      var disqus_identifier = 'find_in_batches-is-not-working';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>

    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>

      </div>
    </section>

    <footer>
      <div class="copyright">
        <p>&copy;2013 Andy Wang</a></p>
      </div>
    </footer>

    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-11967621-1");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>