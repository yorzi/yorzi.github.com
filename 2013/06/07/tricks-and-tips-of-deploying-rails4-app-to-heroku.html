





<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="zh"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="zh"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh"><![endif]-->
<!--[if gt IE 8]<!-->
<html class="no-js" lang="zh">
  <!--<![endif]-->
  <head>
    <meta charset="UTF-8">

    <title>
      Tricks and Tips of Deploying Rails4 App to Heroku - @yorzi
    </title>

    <meta name="description" content="安迪的思考和分享">
    <meta name="keywords" content="Remote Working,Project Management,Team Collaboration,Startup,Entrepreneurship,Ruby/Rails,Web Development,生活">
    <meta name="author" content="Andy Wang">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="cleartype" content="on">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="57x57" href="/apple-touch-icon-57x57-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="72x72" href="/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" type="image/png" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png" />
    <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">

    <link rel="icon" type="image/png" sizes="16x16" href="/wangyaodi.png">
    <link rel="shortcut icon" sizes="16x16" href="/wangyaodi.png">
    <link rel="alternate" type="application/rss+xml" title="@yorzi's Homepage" href="/feed.xml" />
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="/stylesheets/application.css">
    <script src="/javascripts/all.js"></script>
  </head>
  <body class="x2013 x2013_06 x2013_06_07 x2013_06_07_tricks-and-tips-of-deploying-rails4-app-to-heroku">
    <aside class="sidebar">
      <h1 class="site-name"><a href="/" style='color:rgb(162, 9, 9);'>@yorzi</a></h1>
      <nav class="global-nav">
        <ul>
          <li><a href="/profile.html">About</a></li>
          <li><a href="/presentations.html">Presentations</a></li>
          <li><a href="/files/2013-Andy-Wang-Resume-Via-Linkedin.pdf">Resume</a></li>
        </ul>
      </nav>

      <nav class="social-connect">
        <ul>
          <li><a href="//github.com/yorzi"><i class="icon-github"></i></a></li>
          <li><a href="//weibo.com/yorzi"><i class="icon-weibo"></i></a></li>
          <li><a href="//twitter.com/yorzi"><i class="icon-twitter"></i></a></li>
          <li><a href="//cn.linkedin.com/in/yorzi"><i class="icon-linkedin"></i></a></li>
        </ul>
      </nav>

      <!-- Ad -->
      <div class="block ad">
        <p class="block-cnt">Themed By</p>
        <h4 class="block-title"><a href="//fengche.co">风车</a></h4>
      </div>

    </aside>

    <section class="main">
      <div class="container">
        
  <div class="announcement">
    <p>
        <img class="avatar" src="/images/wangyaodi.png" alt="Andy Wang" />
为了练习写作，我开了一个微信公众号<a href='/2015/10/25/why-to-practise-writing-an-article.html'>【爱成长】</a>，每篇Blog都会同步在该公众号中发布，请感兴趣的朋友关注我的微信公众号，微信ID：i-chengzhang 谢谢！


    </p>
  </div>

  <article class="post single">

    <header>
  <h2 class="title">
    <a href="/2013/06/07/tricks-and-tips-of-deploying-rails4-app-to-heroku.html">Tricks and Tips of Deploying Rails4 App to Heroku</a>
  </h2>
</header>

<aside class="aside-block">
  <ul class="meta">
    <li class="date">
      Jun 07, 2013
    </li>
    <li class="tags">
    </li>
  </ul>
</aside>

<div class="content">
  <p>Recently, I deployed a client project to Heroku and made the Heroku instance as an internal demo server. The project is based on Ruby2.0 and Rails4, unexpectedly, the deployment to Heroku is not as smooth as before. Below I&rsquo;d like to share some tricks and tips that I came across. </p>

<h5>Rails4 Specific Tricks</h5>

<ul>
<li>Heroku forces you to specify your ruby version in Gemfile, it&rsquo;s supported by bundler from <a href="http://gembundler.com/v1.2/whats_new.html">1.2 version</a>, so just add below line into your Gemfile:</li>
</ul>

<p>{% codeblock ruby %}</p>

<h1>specify ruby version to enable the deploy to Heroku instance.</h1>

<p>ruby &lsquo;2.0.0&rsquo;
{% endcodeblock %}</p>

<ul>
<li>Rails4 gets rid of plugin system. In order to use features such as static asset serving and logging on Heroku, you should add the following gems to your Gemfile:</li>
</ul>
<pre class="highlight plaintext"><code>gem 'rails_log_stdout',           github: 'Heroku/rails_log_stdout'
gem 'rails3_serve_static_assets', github: 'Heroku/rails3_serve_static_assets'
</code></pre>

<ul>
<li>Use <a href="http://puma.io/">puma</a> as the web server, you want to add a <code>Procfile</code> file and add below line in it:</li>
</ul>
<pre class="highlight plaintext"><code>web: bundle exec puma -p $PORT
</code></pre>

<ul>
<li>Below http basic auth doesn&rsquo;t work as what I did before for non-rails4 app on Heroku.</li>
</ul>
<pre class="highlight plaintext"><code>config.middleware.insert_after(::Rack::Lock, "::Rack::Auth::Basic", "Production") do |u, p|
  [u, p] == [USER, PASSWORD]
end
</code></pre>
<pre class="highlight plaintext"><code># Error message when pushing to Heroku...
-----&gt; Preparing app for Rails asset pipeline
       Running: rake assets:precompile
       rake aborted!
       No such middleware to insert after: Rack::Lock
</code></pre>

<ul>
<li>Actually, Rails4 is thread safe by default, you do not have the overhead of including the <code>Rack::Lock</code> middleware in each request. So just use <code>Rack::Auth::Basic</code> directly as there is no Rack::Lock middleware any more when you using a web server such as <code>puma</code>:</li>
</ul>
<pre class="highlight plaintext"><code>config.middleware.use '::Rack::Auth::Basic' do |u, p|
  [u, p] == [USER, PASSWORD]
end
</code></pre>

<h5>Heroku Related Tips</h5>

<p>In my case, I need to transfer PG database between local and Heroku. Firstly, I need to find the URL to my db on Heroku:</p>
<pre class="highlight plaintext"><code>$ heroku config:get DATABASE_URL
postgres://bla:sth@ec2-17-21-12-11.compute-1.amazonaws.com:5432/123
</code></pre>

<p>Then transfer from the Heroku db to your local db (switch -t <code>to</code> and -f <code>from</code> versus):</p>
<pre class="highlight plaintext"><code>$ heroku plugins:install https://github.com/ddollar/heroku-pg-transfer
$ heroku pg:transfer -t postgres://localhost/dbname -f postgres://bla:sth@ec2-17-21-12-11.compute-1.amazonaws.com:5432/123
</code></pre>

<p>Since the <a href="https://github.com/ddollar/heroku-pg-transfer">heroku-pg-transfer</a> tool utilizes postgres&rsquo;s native pg_dump facility it is a much more predictable and resilient tool. Check out a related blog <a href="http://www.ryandaigle.com/a/pgtransfer-is-the-new-taps">for more details</a>.</p>

<p>There is another needs in my case, I have to deploy <code>development</code> branch to Heroku, but Heroku default is to deploy master branch to their instance, use below command to specify a branch for deployment.</p>
<pre class="highlight plaintext"><code># deploy a specific branch to Heroku
git push heroku other-barnch:master
</code></pre>

<h4>Resources</h4>

<p><a href="https://devcenter.heroku.com/articles/rails4">https://devcenter.heroku.com/articles/rails4</a><br />
<a href="http://blog.remarkablelabs.com/2012/12/rails-4-is-thread-safe-by-default-rails-4-countdown-to-2013">http://blog.remarkablelabs.com/2012/12/rails-4-is-thread-safe-by-default-rails-4-countdown-to-2013</a><br /></p>

</div>

  </article>

  <div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'andyspersonalblog';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>

      </div>
    </section>

    <footer>
      <div class="copyright">
        <p>&copy;2015 Andy Wang</a></p>
      </div>
    </footer>

    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("TOBEADD");
        pageTracker._trackPageview();
      } catch(err) {}
    </script>
  </body>
</html>